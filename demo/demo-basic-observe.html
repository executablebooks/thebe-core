<!DOCTYPE html>
<html>
  <head>
    <title><%= htmlWebpackPlugin.options.title %></title>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
          processEscapes: true
        },
        "HTML-CSS": { fonts: ["TeX"] }
      });
    </script>
    <script
      type="text/javascript"
      async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML"
    ></script>
    <script
      type="text/javascript"
      async
      src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/@curvenote/article/dist/curvenote.css"
    />
    <script src="https://unpkg.com/@curvenote/article"></script>
    <style>
      body {
        padding: 10px;
      }
      pre {
        border: 1px gray solid;
        max-width: 500px;
        padding: 10px;
      }
      .status {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Demo: thebe-core</h1>
    <p>
      This is a demonstration of <em>thebe-core</em> executing an sequence of
      code cells via the Notebook interface
    </p>
    <p>
      The code itself is in 3 cells as follows, but here it is actually injectes
      via javascript, rather than picked up from the page.
    </p>
    <pre>
%matplotlib inline
import numpy as np
import matplotlib.pyplot as plt
import scipy.stats as stats</pre
    >
    <pre>
mu = 5
sigma = 5</pre
    >
    <pre>
plt.ion()
fig, ax = plt.subplots()
x = np.arange(-10,10,0.1)
y = stats.norm.pdf(x, mu, sigma)
ax.plot(x,y);
plt.grid(True)</pre
    >
    <p>
      The page immediately requests a kernel and the kernel status can be
      monitors via a redux subscription.
    </p>
    <p>
      Current server status is
      <span id="server-status" class="status">none</span> and kernel status is
      <span id="kernel-status" class="status">none</span>
    </p>
    <button id="run-all" disabled>run all</button>
    <button id="run-last" disabled>run last</button>
    <button id="restart" disabled>restart</button>
    <p />
    <div data-output="true">
      <img src="/output.png" />
    </div>
    <button
      id="reset"
      title="removes servers/kernels and force binder to rebuild"
      disabled
    >
      hard reset
    </button>
    <script src="/demo-basic-observe.js"></script>
    <script>
      const options = {
        useBinder: false,
        useJupyterLite: true,
        requestKernel: true,
        binderOptions: {
          repo: "binder-examples/requirements",
          ref: "master",
        },
        kernelOptions: {
          name: "python3",
        },
      };

      const code = [
        `
      %matplotlib inline
      import numpy as np
      import matplotlib.pyplot as plt
      import scipy.stats as stats
      `,
        `
      # oxa:mu
      mu = 5
      # oxa:sigma
      sigma = 5
        `,
        `
      plt.ion()
      fig, ax = plt.subplots()
      x = np.arange(-10,10,0.1)
      y = stats.norm.pdf(x, mu, sigma)
      ax.plot(x,y);
      plt.grid(True)
        `,
      ];

      document.addEventListener("DOMContentLoaded", function () {
        function randomId() {
          const uint32 = window.crypto.getRandomValues(new Uint32Array(1))[0];
          return "id-" + uint32.toString(16);
        }

        window.demo = { notebook: null, kernel: null };

        const kernel = bootstrap(
          window.demo,
          options,
          code.map((c) => ({
            id: randomId(),
            source: c,
          }))
        );

        const runAllButton = document.getElementById("run-all");
        runAllButton.onclick = (ev) => {
          window.demo.notebook.executeAll();
        };

        const runLastButton = document.getElementById("run-last");
        runLastButton.onclick = (ev) => {
          window.demo.notebook.executeOnly(window.demo.notebook.lastCell().id);
        };

        const restartButton = document.getElementById("restart");
        restartButton.onclick = (ev) => {
          window.thebeCore.api.restartKernel(demo.kernelId);
        };

        const resetButton = document.getElementById("reset");
        resetButton.onclick = (ev) => {
          window.thebeCore.api.clear();
          window.location.reload();
        };

        kernel.then((kernel) => {
          const dispose = kernel.listen((info) => {
            const serverStatus = document.getElementById("server-status");
            serverStatus.innerText = info.server ? info.server.status : "none";
            const kernelStatus = document.getElementById("kernel-status");
            kernelStatus.innerText = info.kernel ? info.kernel.status : "none";

            if (info.kernel && info.kernel.status === "ready") {
              document.getElementById("run-all").disabled = false;
              document.getElementById("run-last").disabled = false;
              document.getElementById("restart").disabled = false;
              document.getElementById("reset").disabled = false;
              dispose();
            }
          });
        });
      });
    </script>
  </body>
</html>
